---
- name: Preparing Jenkins Server
  hosts: all,jenkins-redhat,srv-vm-jks01
  become: true
  tasks:

  - block:
    - name: Upgrade OS Linux | RedHat
      yum:
        name: "*"
        state: latest
      when: ansible_os_family == 'RedHat'

  - block:
    - name: Upgrade OS Linux | Debian
      apt:
        name: "*"
        state: latest
      when: ansible_os_family == 'Debian'

    - name: Installing Epel | Amazon Linux
      shell: sudo amazon-linux-extras install epel -y
      when: ansible_distribution == 'Amazon'

  - name: Installing Epel | RedHat
    shell: sudo yum install epel-release -y
    when: ansible_os_family == 'RedHat'

  - name: Installing Linux Apps | RedHat
    yum:
      name:
        - daemonize
        - netcat
        - tree
        - java-devel
    when: ansible_os_family == 'RedHat'

  - name: Installing Linux Apps | Debian
    apt:
      name:
        - daemonize
        - netcat
        - tree
        - openjdk-11-jre
    when: ansible_os_family == 'Debian'

  - block:
    - name: Ensure Jenkins repository is added | RedHat
      yum_repository:
        name: jenkins-ci
        description: jenkins-ci package repository
        baseurl: http://pkg.jenkins.io/redhat
        gpgkey: https://pkg.jenkins.io/redhat/jenkins.io.key
        gpgcheck: yes
      when: ansible_os_family == 'RedHat'
    - name: Ensure gpp key is imported | RedHat
      rpm_key:
        state: present
        key: https://pkg.jenkins.io/redhat/jenkins.io.key
      when: ansible_os_family == 'RedHat'

  - block:
    - name: Ensure Jenkins repository is added | Debian
      apt_key:
        url: https://pkg.jenkins.io/debian-stable/jenkins.io.key
        state: present
      when: ansible_os_family == 'Debian'
    - name: Ensure the repository is configured | Debian
      apt_repository:
        repo: 'deb [arch=amd64] https://pkg.jenkins.io/debian-stable binary/'
        state: present
        filename: jenkins-ci
      when: ansible_os_family == 'Debian'

  - block:
    - name: Ensure Jenkins and Java package installed | RedHat
      yum:
        name: jenkins
        state: present
        update_cache: true
      when: ansible_os_family == 'RedHat'
    - name: Ensure systemd daemon reloaded | RedHat
      command: systemctl daemon-reload
      when: ansible_os_family == 'RedHat'

    - name: Ensure Jenkins and Java package installed | Debian
      apt:
        name: jenkins
        state: present
        update_cache: true
      when: ansible_os_family == 'Debian'
    - name: Ensure systemd daemon reloaded | Debian
      command: systemctl daemon-reload
      when: ansible_os_family == 'Debian'

    - name: Ensure Jenkins service is enabled and started
      service:
        name: jenkins
        state: started